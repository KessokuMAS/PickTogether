<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POS ì‹œìŠ¤í…œ - QR ì½”ë“œ ìŠ¤ìº”</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:#f5f5f5; color:#333; }
    .header { background:#2c3e50; color:#fff; padding:20px; text-align:center; }
    .restaurant-name { font-size:24px; font-weight:700; margin-bottom:5px; }
    .pos-title { font-size:14px; opacity:.8; }
    .order-card { background:#fff; margin:20px; padding:20px; border-radius:15px; box-shadow:0 4px 6px rgba(0,0,0,.1); }
    .order-info { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px; }
    .info-item { text-align:center; padding:15px; background:#f8f9fa; border-radius:10px; }
    .info-label { font-size:12px; color:#666; margin-bottom:5px; }
    .info-value { font-size:18px; font-weight:700; }
    .amount { color:#e74c3c; }
    .qr-scan-area { background:linear-gradient(135deg,#e8f5e8,#d4edda); border:3px dashed #27ae60; border-radius:20px; padding:20px; text-align:center; margin:20px 0; position:relative; }
    .qr-icon { font-size:60px; margin-bottom:10px; animation:pulse 2s infinite; }
    .scan-text { font-size:18px; font-weight:700; color:#27ae60; margin-bottom:6px; }
    .scan-subtext { font-size:14px; color:#666; }
    .scan-button { background:#3498db; color:#fff; border:none; padding:15px 30px; border-radius:25px; font-size:16px; font-weight:700; margin:20px; width:calc(100% - 40px); cursor:pointer; transition:.2s; }
    .scan-button:hover { background:#2980b9; transform:translateY(-1px); }
    .scan-button:active { transform:translateY(0); }
    .status-bar { background:#ecf0f1; padding:12px; border-radius:10px; text-align:center; margin-top:10px; }
    .status-text { font-size:16px; font-weight:700; color:#2c3e50; }
    .preview-wrap { display:none; margin-top:12px; }
    video { width:100%; border-radius:12px; background:#000; }
    canvas { display:none; }
    .fallback { margin-top:12px; }
    .ok { color:#16a34a; font-weight:700; }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
  </style>
</head>
<body>
  <div class="header">
    <div class="restaurant-name" id="restaurantName">ë§›ìˆëŠ” ì‹ë‹¹</div>
    <div class="pos-title">POS ì‹œìŠ¤í…œ - QR ì½”ë“œ ìŠ¤ìº”</div>
  </div>

  <div class="order-card">
    <div class="order-info">
      <div class="info-item">
        <div class="info-label">ì£¼ë¬¸ë²ˆí˜¸</div>
        <div class="info-value" id="orderId">12345</div>
      </div>
      <div class="info-item">
        <div class="info-label">ê²°ì œê¸ˆì•¡</div>
        <div class="info-value amount" id="amount">15,000ì›</div>
      </div>
      <div class="info-item">
        <div class="info-label">ê²°ì œìˆ˜ë‹¨</div>
        <div class="info-value" id="paymentMethod">ì¹´ì¹´ì˜¤í˜ì´</div>
      </div>
      <div class="info-item">
        <div class="info-label">ê²°ì œì‹œê°„</div>
        <div class="info-value" id="paymentTime">14:30</div>
      </div>
    </div>

    <div class="qr-scan-area" id="qrScanArea">
      <div class="qr-icon">ğŸ“±</div>
      <div class="scan-text">QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</div>
      <div class="scan-subtext">ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ QR ìŠ¤ìº”ì„ ì‹œì‘í•˜ì„¸ìš”</div>

      <div class="preview-wrap" id="previewWrap">
        <video id="video" playsinline muted></video>
        <canvas id="canvas"></canvas>
      </div>

      <div class="fallback" id="fallbackWrap" style="display:none;">
        <input id="fileInput" type="file" accept="image/*" capture="environment"/>
        <p style="font-size:13px;color:#555;margin-top:6px;">ì¹´ë©”ë¼ê°€ ì°¨ë‹¨ë˜ë©´ ì‚¬ì§„ìœ¼ë¡œë„ ì¸ì‹í•  ìˆ˜ ìˆì–´ìš”.</p>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-text" id="statusText">ëŒ€ê¸°ì¤‘</div>
    </div>

    <button class="scan-button" id="scanButton">ğŸ“± QR ì½”ë“œ ìŠ¤ìº”í•˜ê¸°</button>
  </div>

  <script>
    // ====== ì£¼ë¬¸ ì •ë³´ í‘œì‹œ ======
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('orderId') || '12345';
    const amount  = urlParams.get('amount') || '15000';
    const paymentMethod = urlParams.get('paymentMethod') || 'ì¹´ì¹´ì˜¤í˜ì´';
    const restaurantName = urlParams.get('restaurantName') || 'ë§›ìˆëŠ” ì‹ë‹¹';

    document.getElementById('orderId').textContent = orderId;
    document.getElementById('amount').textContent = Number(amount).toLocaleString() + 'ì›';
    document.getElementById('paymentMethod').textContent = paymentMethod;
    document.getElementById('restaurantName').textContent = restaurantName;
    document.getElementById('paymentTime').textContent = new Date().toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit' });

    // ====== QR ìŠ¤ìº” ë¡œì§ ======
    const statusText = document.getElementById('statusText');
    const scanButton = document.getElementById('scanButton');
    const previewWrap = document.getElementById('previewWrap');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const fallbackWrap = document.getElementById('fallbackWrap');

    let stream = null;
    let scanning = false;
    let barcodeDetector = null;

    // ì§€ì› ì²´í¬
    const supportsBarcodeDetector = 'BarcodeDetector' in window;

    async function startCamera() {
      // HTTPS í•„ìš” (localhostëŠ” ì˜ˆì™¸)
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        statusText.textContent = 'HTTPSì—ì„œë§Œ ì¹´ë©”ë¼ë¥¼ ì—´ ìˆ˜ ìˆì–´ìš”. (GitHub Pages ì¶”ì²œ)';
        fallbackWrap.style.display = 'block';
        return;
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        previewWrap.style.display = 'block';
        statusText.textContent = 'ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ. QRì„ í™”ë©´ì— ë¹„ì¶°ì£¼ì„¸ìš”.';
      } catch (e) {
        console.error(e);
        statusText.textContent = 'ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆê±°ë‚˜ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        fallbackWrap.style.display = 'block';
      }
    }

    async function initBarcode() {
      if (!supportsBarcodeDetector) return false;
      try {
        // QR/ë°”ì½”ë“œ ìœ í˜• ì§€ì • (ìµœì‹  í¬ë¡¬/ì•ˆë“œì—ì„œ ë™ì‘)
        barcodeDetector = new BarcodeDetector({ formats: ['qr_code', 'code_128', 'ean_13'] });
        return true;
      } catch (e) {
        console.warn('BarcodeDetector ì´ˆê¸°í™” ì‹¤íŒ¨', e);
        return false;
      }
    }

    async function scanLoop() {
      if (!scanning) return;
      if (!video.videoWidth) {
        requestAnimationFrame(scanLoop);
        return;
      }

      // ìº”ë²„ìŠ¤ì— í˜„ì¬ í”„ë ˆì„ ê·¸ë¦¬ê¸°
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      try {
        if (barcodeDetector) {
          const bitmap = await createImageBitmap(canvas);
          const codes = await barcodeDetector.detect(bitmap);
          if (codes && codes.length) {
            const val = codes[0].rawValue || codes[0].raw || '';
            onQrDetected(val);
            return;
          }
        } else {
          // ìµœì†Œ fallback: ê°„ë‹¨íˆ ë·°íŒŒì¸ë” ìœ ì§€ (ì •êµí•œ ë””ì½”ë”© ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´)
          // í•„ìš”í•˜ë©´ jsQR ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶™ì´ì„¸ìš”.
        }
      } catch (err) {
        console.warn('ë””í…ì…˜ ì˜¤ë¥˜', err);
      }

      requestAnimationFrame(scanLoop);
    }

    function onQrDetected(value) {
      scanning = false;
      stopCamera();
      statusText.innerHTML = `<span class="ok">QR ì¸ì‹ ì„±ê³µ:</span> ${escapeHtml(value)}`;

      // ì—¬ê¸°ì„œ POS ë¡œì§ ì²˜ë¦¬
      // ì˜ˆ: íŠ¹ì • ìŠ¤í‚¤ë§ˆ ì²˜ë¦¬, ì„œë²„ ê²€ì¦ í˜¸ì¶œ ë“±
      // location.href = value; // URLì´ë©´ ë°”ë¡œ ì´ë™í•˜ëŠ” ì‹ìœ¼ë¡œë„ ê°€ëŠ¥(ì£¼ì˜)
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }

    // ë²„íŠ¼ í´ë¦­: ìŠ¤ìº” ì‹œì‘
    scanButton.addEventListener('click', async () => {
      scanButton.disabled = true;
      scanButton.textContent = 'ì‹¤í–‰ ì¤‘...';
      statusText.textContent = 'ì¹´ë©”ë¼ ì—¬ëŠ” ì¤‘...';

      const ok = await initBarcode();
      await startCamera();

      if (stream) {
        scanning = true;
        scanLoop();
      } else {
        // ì¹´ë©”ë¼ ì‹¤íŒ¨ â†’ íŒŒì¼ ì—…ë¡œë“œ fallback
        fallbackWrap.style.display = 'block';
      }

      // ë²„íŠ¼ ë³µêµ¬
      setTimeout(() => {
        scanButton.disabled = false;
        scanButton.textContent = 'ğŸ“± QR ì½”ë“œ ìŠ¤ìº”í•˜ê¸°';
      }, 600);
    });

    // í˜ì´ì§€ ìˆ¨ê¹€/ì´íƒˆ ì‹œ ì¹´ë©”ë¼ ì •ë¦¬
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopCamera();
    });
    window.addEventListener('beforeunload', stopCamera);

    // íŒŒì¼ ì—…ë¡œë“œ fallback: ì‚¬ì§„ì—ì„œ QR ì‹œë„ (ì—¬ê¸°ì„  ë‹¨ìˆœ í‘œì‹œë§Œ)
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const img = new Image();
      img.onload = async () => {
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        if (barcodeDetector) {
          try {
            const bmp = await createImageBitmap(canvas);
            const codes = await barcodeDetector.detect(bmp);
            if (codes && codes.length) {
              const val = codes[0].rawValue || '';
              onQrDetected(val);
              return;
            }
          } catch (e) {
            console.warn('ì´ë¯¸ì§€ ë””í…ì…˜ ì‹¤íŒ¨', e);
          }
        }
        statusText.textContent = 'ì´ë¯¸ì§€ì—ì„œ QRì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
      };
      img.onerror = () => {
        statusText.textContent = 'ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      };
      img.src = URL.createObjectURL(file);
    });

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
