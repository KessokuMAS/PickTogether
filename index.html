<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POS 시스템 - QR 코드 스캔</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f5f5f5; color: #333;
      }
      .header { background: #2c3e50; color: #fff; padding: 20px; text-align: center; }
      .restaurant-name { font-size: 24px; font-weight: 700; margin-bottom: 5px; }
      .pos-title { font-size: 14px; opacity: 0.8; }
      .order-card {
        background: #fff; margin: 20px; padding: 20px; border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      .order-info {
        display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;
      }
      .info-item { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px; }
      .info-label { font-size: 12px; color: #666; margin-bottom: 5px; }
      .info-value { font-size: 18px; font-weight: 700; }
      .amount { color: #e74c3c; }
      .qr-scan-area {
        background: linear-gradient(135deg, #e8f5e8, #d4edda);
        border: 3px dashed #27ae60; border-radius: 20px; padding: 20px; text-align: center;
        margin: 20px 0; position: relative;
      }
      .qr-icon { font-size: 60px; margin-bottom: 10px; animation: pulse 2s infinite; }
      .scan-text { font-size: 18px; font-weight: 700; color: #27ae60; margin-bottom: 6px; }
      .scan-subtext { font-size: 14px; color: #666; }
      .scan-button {
        background: #3498db; color: #fff; border: none; padding: 15px 30px; border-radius: 25px;
        font-size: 16px; font-weight: 700; margin: 20px; width: calc(100% - 40px);
        cursor: pointer; transition: 0.2s;
      }
      .scan-button:hover { background: #2980b9; transform: translateY(-1px); }
      .scan-button:active { transform: translateY(0); }
      .status-bar { background: #ecf0f1; padding: 12px; border-radius: 10px; text-align: center; margin-top: 10px; }
      .status-text { font-size: 16px; font-weight: 700; color: #2c3e50; }
      .preview-wrap { display: none; margin-top: 12px; }
      video { width: 100%; border-radius: 12px; background: #000; }
      canvas { display: none; }
      .fallback { margin-top: 12px; }
      .ok { color: #16a34a; font-weight: 700; }
      @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="pos-title">POS 시스템 - QR 코드 스캔</div>
    </div>

    <div class="order-card">
      <div class="order-info">
        <div class="info-item">
          <div class="info-label">주문번호</div>
          <div class="info-value" id="orderId">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">결제금액</div>
          <div class="info-value amount" id="amount">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">결제수단</div>
          <div class="info-value" id="paymentMethod">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">결제시간</div>
          <div class="info-value" id="paymentTime">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">결제 ID</div>
          <div class="info-value" id="paymentId">-</div>
        </div>
      </div>

      <div class="qr-scan-area" id="qrScanArea">
        <div class="qr-icon">📱</div>
        <div class="scan-text">QR 코드를 스캔하세요</div>
        <div class="scan-subtext">아래 버튼을 눌러 QR 스캔을 시작하세요</div>

        <div class="preview-wrap" id="previewWrap">
          <video id="video" playsinline muted></video>
          <canvas id="canvas"></canvas>
        </div>

        <div class="fallback" id="fallbackWrap" style="display: none">
          <input id="fileInput" type="file" accept="image/*" capture="environment" />
          <p style="font-size: 13px; color: #555; margin-top: 6px">
            카메라가 차단되면 사진으로도 인식할 수 있어요.
          </p>
        </div>
      </div>

      <div class="status-bar">
        <div class="status-text" id="statusText">대기중</div>
      </div>

      <button class="scan-button" id="scanButton">📱 QR 코드 스캔하기</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
      // ====== 주문 정보 업데이트용 normalize ======
      function normalizeOrderData(obj) {
        const toNumber = (v) => {
          if (!v) return undefined;
          const n = Number(String(v).replace(/[^0-9]/g, ""));
          return Number.isFinite(n) ? n : undefined;
        };
        const fmtTime = (t) => {
          if (!t) return new Date().toLocaleString("ko-KR",{hour12:false});
          const d = new Date(t);
          return isNaN(d)? t : d.toLocaleString("ko-KR",{hour12:false});
        };
        return {
          orderId: obj.orderId ?? obj.fundingId ?? obj.impUid ?? "-",
          amount: toNumber(obj.amount ?? obj.totalAmount),
          paymentMethod: obj.paymentMethod ?? (obj.impUid? "간편결제":"-"),
          paymentTime: fmtTime(obj.paymentTime ?? obj.createdAt),
          restaurantName: obj.restaurantName,
          paymentId: obj.impUid ?? "-"
        };
      }
      function updateOrderInfo(data) {
        if (data.orderId) document.getElementById("orderId").textContent = data.orderId;
        if (data.amount != null) document.getElementById("amount").textContent = data.amount.toLocaleString()+"원";
        if (data.paymentMethod) document.getElementById("paymentMethod").textContent = data.paymentMethod;
        if (data.paymentTime) document.getElementById("paymentTime").textContent = data.paymentTime;
        if (data.restaurantName) document.getElementById("restaurantName").textContent = data.restaurantName;
        if (data.paymentId) document.getElementById("paymentId").textContent = data.paymentId;
      }

      // ====== QR 인식 이벤트 ======
      function onQrDetected(value) {
        scanning = false;
        stopCamera();
        try {
          const parsed = JSON.parse(value);
          const normalized = normalizeOrderData(parsed);
          updateOrderInfo(normalized);
          // 여기서 메시지를 "사용이 완료되었습니다" 로 고정
          statusText.innerHTML = `<span class="ok">사용이 완료되었습니다 ✅</span>`;
        } catch {
          statusText.innerHTML = `<span class="ok">사용이 완료되었습니다 ✅</span>`;
        }
      }

      // ====== 카메라/스캔 로직 기존 코드 ======
      const statusText = document.getElementById("statusText");
      const scanButton = document.getElementById("scanButton");
      const previewWrap = document.getElementById("previewWrap");
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const fallbackWrap = document.getElementById("fallbackWrap");
      let stream = null; let scanning = false; let barcodeDetector = null;

      async function startCamera() {
        if (location.protocol!=="https:" && location.hostname!=="localhost"){
          statusText.textContent="HTTPS에서만 카메라 사용 가능"; fallbackWrap.style.display="block"; return;
        }
        try{
          stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:false});
          video.srcObject=stream; await video.play();
          previewWrap.style.display="block";
          statusText.textContent="카메라 준비 완료. QR을 화면에 비춰주세요.";
        }catch{statusText.textContent="카메라 권한 거부됨"; fallbackWrap.style.display="block";}
      }
      async function initBarcode(){
        if(!("BarcodeDetector" in window)) return false;
        try{barcodeDetector=new BarcodeDetector({formats:["qr_code","code_128","ean_13"]});return true;}
        catch{return false;}
      }
      async function scanLoop(){
        if(!scanning) return;
        if(!video.videoWidth){requestAnimationFrame(scanLoop);return;}
        canvas.width=video.videoWidth; canvas.height=video.videoHeight;
        const ctx=canvas.getContext("2d"); ctx.drawImage(video,0,0);
        try{
          if(barcodeDetector){
            const bmp=await createImageBitmap(canvas);
            const codes=await barcodeDetector.detect(bmp);
            if(codes.length){onQrDetected(codes[0].rawValue); return;}
          }else{
            const img=ctx.getImageData(0,0,canvas.width,canvas.height);
            const code=jsQR(img.data,img.width,img.height);
            if(code){onQrDetected(code.data); return;}
          }
        }catch(e){}
        requestAnimationFrame(scanLoop);
      }
      function stopCamera(){if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;}}
      scanButton.addEventListener("click", async ()=>{
        scanButton.disabled=true; scanButton.textContent="실행 중...";
        statusText.textContent="카메라 여는 중...";
        await initBarcode(); await startCamera();
        if(stream){scanning=true; scanLoop();} else {fallbackWrap.style.display="block";}
        setTimeout(()=>{scanButton.disabled=false; scanButton.textContent="📱 QR 코드 스캔하기";},600);
      });
      document.addEventListener("visibilitychange",()=>{if(document.hidden) stopCamera();});
      window.addEventListener("beforeunload",stopCamera);
    </script>
  </body>
</html>
