<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POS 시스템 - QR 코드 스캔</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f5f5f5; color: #333;
      }
      .header { background: #2c3e50; color: #fff; padding: 20px; text-align: center; }
      .restaurant-name { font-size: 24px; font-weight: 700; margin-bottom: 5px; }
      .pos-title { font-size: 14px; opacity: 0.8; }
      .order-card {
        background: #fff; margin: 20px; padding: 20px; border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      .order-info {
        display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;
      }
      .info-item { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px; }
      .info-label { font-size: 12px; color: #666; margin-bottom: 5px; }
      .info-value { font-size: 18px; font-weight: 700; }
      .amount { color: #e74c3c; }
      .qr-scan-area {
        background: linear-gradient(135deg, #e8f5e8, #d4edda);
        border: 3px dashed #27ae60; border-radius: 20px; padding: 20px; text-align: center;
        margin: 20px 0; position: relative;
      }
      .qr-icon { font-size: 60px; margin-bottom: 10px; animation: pulse 2s infinite; }
      .scan-text { font-size: 18px; font-weight: 700; color: #27ae60; margin-bottom: 6px; }
      .scan-subtext { font-size: 14px; color: #666; }
      .scan-button {
        background: #3498db; color: #fff; border: none; padding: 15px 30px; border-radius: 25px;
        font-size: 16px; font-weight: 700; margin: 20px; width: calc(100% - 40px);
        cursor: pointer; transition: 0.2s;
      }
      .scan-button:hover { background: #2980b9; transform: translateY(-1px); }
      .scan-button:active { transform: translateY(0); }
      .status-bar { background: #ecf0f1; padding: 12px; border-radius: 10px; text-align: center; margin-top: 10px; }
      .status-text { font-size: 16px; font-weight: 700; color: #2c3e50; }
      .preview-wrap { display: none; margin-top: 12px; }
      video { width: 100%; border-radius: 12px; background: #000; }
      canvas { display: none; }
      .fallback { margin-top: 12px; }
      .ok { color: #16a34a; font-weight: 700; }
      @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="restaurant-name" id="restaurantName">맛있는 식당</div>
      <div class="pos-title">POS 시스템 - QR 코드 스캔</div>
    </div>

    <div class="order-card">
      <div class="order-info">
        <div class="info-item">
          <div class="info-label">주문번호</div>
          <div class="info-value" id="orderId">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">결제금액</div>
          <div class="info-value amount" id="amount">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">결제수단</div>
          <div class="info-value" id="paymentMethod">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">결제시간</div>
          <div class="info-value" id="paymentTime">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">결제 ID</div>
          <div class="info-value" id="paymentId">-</div>
        </div>
      </div>

      <div class="qr-scan-area" id="qrScanArea">
        <div class="qr-icon">📱</div>
        <div class="scan-text">QR 코드를 스캔하세요</div>
        <div class="scan-subtext">아래 버튼을 눌러 QR 스캔을 시작하세요</div>

        <div class="preview-wrap" id="previewWrap">
          <video id="video" playsinline muted></video>
          <canvas id="canvas"></canvas>
        </div>

        <div class="fallback" id="fallbackWrap" style="display: none">
          <input id="fileInput" type="file" accept="image/*" capture="environment" />
          <p style="font-size: 13px; color: #555; margin-top: 6px">
            카메라가 차단되면 사진으로도 인식할 수 있어요.
          </p>
        </div>
      </div>

      <div class="status-bar">
        <div class="status-text" id="statusText">대기중</div>
      </div>

      <button class="scan-button" id="scanButton">📱 QR 코드 스캔하기</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
      // ====== URL 파라미터로도 채워지게(양쪽 스키마 지원) ======
      const urlParams = new URLSearchParams(window.location.search);
      const initialObj = {
        // 기존 스키마
        orderId: urlParams.get("orderId") || undefined,
        amount: urlParams.get("amount") ? Number(urlParams.get("amount")) : undefined,
        paymentMethod: urlParams.get("paymentMethod") || undefined,
        paymentTime: urlParams.get("paymentTime") || undefined,
        restaurantName: urlParams.get("restaurantName") || undefined,
        // 새 스키마(네가 주는 QR JSON)
        fundingId: urlParams.get("fundingId") || undefined,
        totalAmount: urlParams.get("totalAmount") ? Number(urlParams.get("totalAmount")) : undefined,
        impUid: urlParams.get("impUid") || undefined,
        createdAt: urlParams.get("createdAt") || undefined,
      };
      if (Object.values(initialObj).some(Boolean)) {
        updateOrderInfo(normalizeOrderData(initialObj));
      } else {
        // 기본 표시
        document.getElementById("paymentTime").textContent = nowTime();
      }

      // ====== QR 스캔 로직 ======
      const statusText = document.getElementById("statusText");
      const scanButton = document.getElementById("scanButton");
      const previewWrap = document.getElementById("previewWrap");
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const fallbackWrap = document.getElementById("fallbackWrap");

      let stream = null;
      let scanning = false;
      let barcodeDetector = null;
      const supportsBarcodeDetector = "BarcodeDetector" in window;

      async function startCamera() {
        // HTTPS 필요 (localhost 예외)
        if (location.protocol !== "https:" && location.hostname !== "localhost") {
          statusText.textContent = "HTTPS에서만 카메라를 열 수 있어요. (GitHub Pages 추천)";
          fallbackWrap.style.display = "block";
          return;
        }
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } },
            audio: false,
          });
          video.srcObject = stream;
          await video.play();
          previewWrap.style.display = "block";
          statusText.textContent = "카메라 준비 완료. QR을 화면에 비춰주세요.";
        } catch (e) {
          console.error(e);
          statusText.textContent = "카메라 권한이 거부되었거나 열 수 없습니다.";
          fallbackWrap.style.display = "block";
        }
      }

      async function initBarcode() {
        if (!supportsBarcodeDetector) return false;
        try {
          barcodeDetector = new BarcodeDetector({ formats: ["qr_code", "code_128", "ean_13"] });
          return true;
        } catch (e) {
          console.warn("BarcodeDetector 초기화 실패", e);
          return false;
        }
      }

      async function scanLoop() {
        if (!scanning) return;
        if (!video.videoWidth) { requestAnimationFrame(scanLoop); return; }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        try {
          if (barcodeDetector) {
            const bitmap = await createImageBitmap(canvas);
            const codes = await barcodeDetector.detect(bitmap);
            if (codes && codes.length) {
              const val = codes[0].rawValue || codes[0].raw || "";
              onQrDetected(val);
              return;
            }
          } else {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) {
              onQrDetected(code.data);
              return;
            }
          }
        } catch (err) {
          console.warn("디텍션 오류", err);
        }
        requestAnimationFrame(scanLoop);
      }

      // ====== 스키마 정규화 ======
      function normalizeOrderData(obj) {
        // 숫자 깔끔히
        const toNumber = (v) => {
          if (v == null) return undefined;
          if (typeof v === "number") return v;
          const s = String(v).replace(/[^0-9.-]/g, "");
          const n = Number(s);
          return Number.isFinite(n) ? n : undefined;
        };

        // 시간 포맷팅 (KST 로컬)
        const fmtTime = (t) => {
          if (!t) return undefined;
          const d = new Date(t);
          if (isNaN(d)) return t; // 이상하면 원본 노출
          return d.toLocaleString("ko-KR", { hour12: false });
        };

        // 결제수단 추정: impUid가 있으면 간편결제 계열로 표기(필요시 바꿔)
        const inferredMethod = obj.paymentMethod
          || (obj.impUid ? "간편결제" : undefined);

        return {
          orderId: obj.orderId ?? obj.fundingId ?? obj.impUid ?? "-",
          amount: toNumber(obj.amount ?? obj.totalAmount),
          paymentMethod: inferredMethod ?? "-",
          paymentTime: obj.paymentTime ? fmtTime(obj.paymentTime) : (obj.createdAt ? fmtTime(obj.createdAt) : nowTime()),
          restaurantName: obj.restaurantName,
          paymentId: obj.impUid ?? "-", // 결제ID 표시
        };
      }

      function updateOrderInfo(data) {
        if (!data) return;
        if (data.orderId) document.getElementById("orderId").textContent = data.orderId;
        if (data.amount != null) document.getElementById("amount").textContent = Number(data.amount).toLocaleString() + "원";
        if (data.paymentMethod) document.getElementById("paymentMethod").textContent = data.paymentMethod;
        if (data.paymentTime) document.getElementById("paymentTime").textContent = data.paymentTime;
        if (data.restaurantName) document.getElementById("restaurantName").textContent = data.restaurantName;
        if (data.paymentId) document.getElementById("paymentId").textContent = data.paymentId;
      }

      function onQrDetected(value) {
        scanning = false;
        stopCamera();
        try {
          const parsed = JSON.parse(value);
          const normalized = normalizeOrderData(parsed);
          updateOrderInfo(normalized);
          statusText.innerHTML = `<span class="ok">QR 인식 성공!</span> 주문 정보가 업데이트되었습니다.`;
        } catch (e) {
          statusText.innerHTML = `<span class="ok">QR 인식 성공:</span> ${escapeHtml(value)}`;
        }
      }

      function stopCamera() {
        if (stream) {
          stream.getTracks().forEach((t) => t.stop());
          stream = null;
        }
      }

      // 버튼 클릭: 스캔 시작
      scanButton.addEventListener("click", async () => {
        scanButton.disabled = true;
        scanButton.textContent = "실행 중...";
        statusText.textContent = "카메라 여는 중...";

        await initBarcode();
        await startCamera();

        if (stream) {
          scanning = true;
          scanLoop();
        } else {
          fallbackWrap.style.display = "block";
        }

        setTimeout(() => {
          scanButton.disabled = false;
          scanButton.textContent = "📱 QR 코드 스캔하기";
        }, 600);
      });

      document.addEventListener("visibilitychange", () => { if (document.hidden) stopCamera(); });
      window.addEventListener("beforeunload", stopCamera);

      // 파일 업로드로도 인식
      document.getElementById("fileInput").addEventListener("change", async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        const img = new Image();
        img.onload = async () => {
          canvas.width = img.width; canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);

          if (barcodeDetector) {
            try {
              const bmp = await createImageBitmap(canvas);
              const codes = await barcodeDetector.detect(bmp);
              if (codes && codes.length) {
                const val = codes[0].rawValue || "";
                onQrDetected(val);
                return;
              }
            } catch (e) { console.warn("이미지 디텍션 실패", e); }
          } else {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) { onQrDetected(code.data); return; }
          }
          statusText.textContent = "이미지에서 QR을 찾지 못했습니다.";
        };
        img.onerror = () => { statusText.textContent = "이미지를 불러올 수 없습니다."; };
        img.src = URL.createObjectURL(file);
      });

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
      }
      function nowTime() {
        return new Date().toLocaleString("ko-KR", { hour12: false });
      }
    </script>
  </body>
</html>
