<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>펀딩 완료</title>
  <style>
    :root {
      --bg1: #f0fdf4;
      --bg2: #ffffff;
      --fg1: #111827;
      --fg2: #374151;
      --accent: #10b981;
      --muted: #6b7280;
      --shadow: 0 10px 20px rgba(0,0,0,.06);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg1), #fff);
      color: var(--fg1);
    }
    .wrap {
      min-height: 100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
    }
    .card {
      width: 100%;
      max-width: 520px;
      background: var(--bg2);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
      animation: pop .2s ease-out;
    }
    @keyframes pop { from { transform: scale(.98); opacity: .0 } to { transform: scale(1); opacity: 1 } }
    .ok {
      width:72px;height:72px;border-radius:50%;
      display:grid;place-items:center;
      margin: 4px auto 12px;
      background: rgba(16,185,129,.12);
      color: var(--accent);
      font-size: 40px;
    }
    h1{margin:8px 0 4px;font-size:22px;}
    p.subtitle{margin:0 0 18px;color:var(--muted)}
    .rows {border-top:1px solid #eef2f7;margin-top:8px}
    .row {
      display:flex;justify-content:space-between;gap:12px;
      padding: 12px 0;border-bottom:1px dashed #eef2f7;
    }
    .row:last-child{border-bottom:0}
    .key {color:#6b7280;font-weight:600}
    .val {color:#111827;font-weight:600; text-align:right; word-break: break-all;}
    .btns {
      display:flex; gap:10px; margin-top:18px; flex-wrap:wrap;
    }
    .btn {
      flex:1 1 auto;
      padding:12px 14px; border-radius:12px; text-align:center;
      text-decoration:none; font-weight:700;
      border:1px solid #e5e7eb; background:#f9fafb; color:#111827;
      transition:.15s ease;
    }
    .btn.primary{ background: var(--accent); color:#fff; border-color: var(--accent); }
    .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }
    .help { margin-top:10px; text-align:center; font-size:12px; color:#6b7280 }
    .badge {
      display:inline-block; padding:4px 8px; border-radius:999px;
      font-size:12px; font-weight:700; background:#ecfeff; color:#0ea5e9; border:1px solid #cffafe;
    }
    .err { color:#b91c1c; background:#fef2f2; border:1px solid #fee2e2; padding:10px 12px; border-radius:12px; font-size:14px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="ok" aria-hidden="true">✓</div>
      <h1>펀딩이 완료되었습니다</h1>
      <p class="subtitle" id="subtitle">가게 정보를 불러오는 중…</p>

      <div class="rows" id="rows" hidden>
        <div class="row">
          <div class="key">펀딩 ID</div>
          <div class="val mono" id="fundingId">-</div>
        </div>
        <div class="row">
          <div class="key">가게명</div>
          <div class="val" id="restaurantName">-</div>
        </div>
        <div class="row">
          <div class="key">결제 번호</div>
          <div class="val mono" id="impUid">-</div>
        </div>
        <div class="row">
          <div class="key">결제 금액</div>
          <div class="val" id="totalAmount">-</div>
        </div>
        <div class="row">
          <div class="key">결제 일시</div>
          <div class="val" id="createdAt">-</div>
        </div>
      </div>

      <div class="btns">
        <a class="btn primary" id="goHome" href="#">홈으로</a>
        <a class="btn" id="goMyFunding" href="#">내 펀딩 내역</a>
        <a class="btn" id="printBtn" href="#">영수증 인쇄</a>
      </div>

      <div class="help">
        <span class="badge">QR 수신 페이지</span>
        URL 파라미터만 있으면 서버 없이 동작합니다.
      </div>
    </div>
  </div>

  <script>
    (function () {
      /**
       * 지원하는 입력 형태
       * 1) 개별 파라미터
       *    ?fundingId=1025&restaurantName=대우부대찌개&impUid=imp_...&totalAmount=6500&createdAt=2025-08-21T17:25:06.379891
       * 2) JSON 통째로 (URL 인코딩)
       *    ?data=%7B%22fundingId%22%3A1025%2C...%7D
       */
      const params = new URLSearchParams(location.search);

      function parseFromParams() {
        // 우선 data(JSON) 우선
        const dataStr = params.get("data");
        if (dataStr) {
          try {
            const obj = JSON.parse(decodeURIComponent(dataStr));
            return obj;
          } catch (e) {
            console.warn("data 파라미터 JSON 파싱 실패:", e);
          }
        }
        // 개별 파라미터
        const obj = {
          fundingId: numOrStr(params.get("fundingId")),
          restaurantName: params.get("restaurantName"),
          impUid: params.get("impUid"),
          totalAmount: numOrStr(params.get("totalAmount")),
          createdAt: params.get("createdAt"),
        };
        // 값 하나도 없으면 null
        const hasAny = Object.values(obj).some(v => v !== null && v !== "" && v !== undefined);
        return hasAny ? obj : null;
      }

      function numOrStr(v) {
        if (v === null || v === undefined || v === "") return null;
        const n = Number(v);
        return Number.isFinite(n) ? n : v;
      }

      function formatAmount(v) {
        const n = Number(v);
        if (Number.isFinite(n)) return n.toLocaleString("ko-KR") + " 원";
        // "6500원" 같은 문자열도 처리
        const digits = String(v || "").replace(/[^\d]/g, "");
        if (digits) return Number(digits).toLocaleString("ko-KR") + " 원";
        return "-";
      }

      function formatKST(isoLike) {
        if (!isoLike) return "-";
        // iOS 호환을 위해 T를 공백으로 치환하여 파싱 보정
        const cleaned = isoLike.replace(" ", "T");
        const d = new Date(cleaned);
        if (isNaN(d.getTime())) return String(isoLike);
        return new Intl.DateTimeFormat("ko-KR", {
          year: "numeric", month: "2-digit", day: "2-digit",
          hour: "2-digit", minute: "2-digit", second: "2-digit",
          hour12: false
        }).format(d);
      }

      // 기본값(네가 예시로 준 값)
      const FALLBACK = {
        fundingId: 1025,
        restaurantName: "대우부대찌개",
        impUid: "imp_478648649884",
        totalAmount: 6500,
        createdAt: "2025-08-21T17:25:06.379891",
      };

      const data = parseFromParams() || FALLBACK;

      // 렌더링
      const subtitle = document.getElementById("subtitle");
      const rows = document.getElementById("rows");
      const setText = (id, text) => document.getElementById(id).textContent = text;

      if (!data) {
        subtitle.outerHTML = '<div class="err">유효한 파라미터가 없습니다. QR 생성 시 쿼리스트링을 포함해주세요.</div>';
      } else {
        subtitle.textContent = `${data.restaurantName || "-"} 에서 맛있는 한 끼를 즐겨보세요 🎉`;
        rows.hidden = false;
        setText("fundingId", data.fundingId ?? "-");
        setText("restaurantName", data.restaurantName ?? "-");
        setText("impUid", data.impUid ?? "-");
        setText("totalAmount", formatAmount(data.totalAmount));
        setText("createdAt", formatKST(data.createdAt));
      }

      // 버튼 액션 (필요 시 네 URL로 교체)
      const $home = document.getElementById("goHome");
      const $my = document.getElementById("goMyFunding");
      const $print = document.getElementById("printBtn");

      $home.addEventListener("click", (e) => {
        e.preventDefault();
        // 프로젝트 홈 URL 있으면 여기에 넣어
        // location.href = "https://example.com/";
        history.length > 1 ? history.back() : alert("홈 URL을 설정하세요.");
      });

      $my.addEventListener("click", (e) => {
        e.preventDefault();
        // 내 펀딩 내역 URL 있으면 교체
        // location.href = "https://example.com/myfunding";
        alert("내 펀딩 내역 URL을 설정하세요.");
      });

      $print.addEventListener("click", (e) => {
        e.preventDefault();
        window.print();
      });
    })();
  </script>
</body>
</html>
